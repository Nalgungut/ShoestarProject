<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shoestar.client.prod.dao.ProdDao">
	
	<!-- 할인율 검색하는 쿼리문 -->
	<sql id="discount">
		
	</sql>
	
	<select id="prodList" parameterType="prod" resultType="prod">
		SELECT
			*
		FROM
			(
			SELECT
				/*+ INDEX_DESC(prod prod_pk)*/
				rownum rn, rowid ri,
				pd_no, pd_name, pd_sex, pd_age, pct_no,
				(
				SELECT
					pct_name
				FROM
					prod_ctg
				WHERE
					pct_no = prod.pct_no
				) AS pct_name,
				co_no, pd_price, pd_fabric, pd_country, pd_year, pd_manu,
				pd_import, pi_no, pd_date, pd_status, pim_main
			FROM
				prod
			WHERE
				<![CDATA[rownum <= #{pageNum} * #{amount}]]>
			) prodlist
		WHERE
			<![CDATA[rn > (#{pageNum} - 1) * #{amount}]]>
			<!-- 성별 -->
			<trim prefix="AND"><choose>
				<when test='pd_sex == "m"'> <!-- male -->
					pd_sex = 'm'
				</when>
				<when test='pd_sex == "f"'> <!-- female -->
					pd_sex = 'f'
				</when>
			</choose></trim>
			<!-- 연령 -->
			<trim prefix="AND"><choose>
				<when test='pd_age == "a"'> <!-- all -->
				</when>
				<when test='pd_age == "k"'> <!-- kids -->
					pd_age = 'k'
				</when>
				<otherwise>
					pd_age = 'a'
				</otherwise>
			</choose></trim>
			<!-- 컬렉션 -->
			<if test="co_no != 0">
				AND co_no = #{co_no}
			</if>
			<!-- 이름 검색 -->
			<if test="keyword != null and keyword != ''">
				AND (pd_name LIKE '%'||#{keyword}||'%')
			</if>
			<!-- 사이즈와 컬러 필터링 -->
			<if test="size != 0 or color != 0">
				AND (
					SELECT DISTINCT
						1
					FROM
						prod_ins
					WHERE
					<trim>
						pd_no = prodlist.pd_no
						<if test="size != 0">
						AND pi_size = #{size}
						</if>
						<if test="color != 0">
						AND pcl_no = #{color}
						</if>
					</trim>
				) IS NOT NULL
			</if>
			<!-- 가격 범위 -->
			<if test="priceBottom != 0">
   				AND pd_price <![CDATA[>= #{priceBottom}]]>
			</if>
			<if test="priceTop != 0">
   				AND pd_price <![CDATA[< #{priceTop}]]>
			</if>
	</select>
	
	
</mapper>