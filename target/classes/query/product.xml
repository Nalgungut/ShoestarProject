<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shoestar.client.prod.dao.ProdDao">
	
	<!-- 최대 할인율 검색하는 쿼리문 -->
	<sql id="dcmax">
		(
		SELECT
			MAX(rd_discount) AS maximum
		FROM
			range_discount r
			INNER JOIN
				rd_type rt
			ON
				r.rd_no = rt.rd_no
			INNER JOIN
				rd_product rp
			ON
				r.rd_no = rp.rd_no
			INNER JOIN
				prod p
			ON
				rt.pct_no = p.pct_no OR
				rp.pd_no = p.pd_no
		WHERE
			(
				RD_EDATE >= TRUNC(sysdate) OR
				RD_EDATE IS NULL
			)
			AND	p.pd_no = prod.pd_no
		)
	</sql>
	
	<!-- 전체 검색 -->
	<select id="prodList" parameterType="prod" resultType="prod">
		SELECT
			*
		FROM
			(
			SELECT
				/*+ INDEX_DESC(prod prod_pk)*/
				rownum rn, rowid ri,
				pd_no, pd_name, pd_sex, pd_age, pct_no, co_no, pd_price,
				pd_fabric, pd_country, pd_year, pd_manu, pd_import, pi_no, pd_date, pd_status, pim_main,
				<!-- 카테고리 이름 받기 -->
				(
				SELECT
					pct_name
				FROM
					prod_ctg
				WHERE
					pct_no = prod.pct_no
				) AS pct_name,
				<!-- 할인율 계산 하기 -->
				(
				NVL((
					<include refid="dcmax"></include>
				), 0)
				) AS pd_discount
			FROM
				prod
			WHERE
				<!-- 성별 -->
				<trim prefixOverrides="AND">
					<if test='pd_sex != null and pd_sex != ""'>
						AND pd_sex = #{pd_sex}
					</if>
					<!-- 연령 -->
					<trim prefix="AND"><choose>
						<when test='pd_age == null'> <!-- default -->
							pd_age = 'a'
						</when>
						<when test='pd_age == "all"'> <!-- all -->
						</when>
						<otherwise>
							pd_age = #{pd_age}
						</otherwise>
					</choose></trim>
					<!-- 컬렉션 -->
					<if test="co_no != 0">
						AND co_no = #{co_no}
					</if>
					<!-- 이름 검색 -->
					<if test='keyword != null and keyword != ""'>
						AND (pd_name LIKE '%'||#{keyword}||'%')
					</if>
					<!-- 사이즈와 컬러 필터링 -->
					<if test="size != 0 or color != 0">
						AND (
							SELECT DISTINCT
								1
							FROM
								prod_ins
							WHERE
							<trim>
								pd_no = prodlist.pd_no
								<if test="size != 0">
								AND pi_size = #{size}
								</if>
								<if test="color != 0">
								AND pcl_no = #{color}
								</if>
							</trim>
						) IS NOT NULL
					</if>
					<!-- 가격 범위 -->
					<if test="priceBottom != 0">
		   				AND
							pd_price * NVL((100-(<include refid="dcmax"></include>))/100, 1)
						<![CDATA[>= #{priceBottom}]]>
					</if>
					<if test="priceTop != 0">
		   				AND
							pd_price * NVL((100-(<include refid="dcmax"></include>))/100, 1)
						<![CDATA[< #{priceTop}]]>
					</if>
					<!-- 페이징 -->
					<![CDATA[AND rownum <= #{pageNum} * #{amount}]]>
				</trim>
			) prodlist
		WHERE
			<![CDATA[rn > (#{pageNum} - 1) * #{amount}]]>

	</select>
	
	<!-- 상품 검색 -->
	<select id="prodDetail" parameterType="prod" resultType="prod">
		SELECT
			*
		FROM
			prod
		WHERE
			pd_no = #{pd_no}
	</select>
</mapper>